# üé≠ NarrativeOrchestrator (Game Master, GM)  
## –°–≤–æ–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è  
*–í–µ—Ä—Å–∏—è 1.0 ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è*

> **GM ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—ã–π, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º—ã–π, stateful-–∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ —Å–æ–±—ã—Ç–∏—é –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –æ–±–ª–∞—Å—Ç–∏.  
> –û–Ω –Ω–µ —Ä–µ—à–∞–µ—Ç, –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç, –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç. –û–Ω *–Ω–∞–±–ª—é–¥–∞–µ—Ç, —Å–æ–±–∏—Ä–∞–µ—Ç —Ñ–∞–∫—Ç—ã, –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö LLM ‚Äî –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç*.  
> –í—Å—è —Ç–≤–æ—Ä—á–µ—Å–∫–∞—è, –¥—Ä–∞–º–∞—Ç—É—Ä–≥–∏—á–µ—Å–∫–∞—è –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ª–µ–∂–∏—Ç –Ω–∞ LLM.**

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–º–º–µ—Ä—Å–∏–≤–Ω–æ–µ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª—é–±–æ–π –æ–±–ª–∞—Å—Ç–∏ (`scope_id`)  
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—é–∂–µ—Ç–Ω–æ–π –¥—É–≥–∏ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏  
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:
  - **Semantic Memory Builder** ‚Äî –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –º–∏—Ä–∞,  
  - **LLM** (—á–µ—Ä–µ–∑ `/v1/chat/completions`) ‚Äî –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π.

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏—è–º–∏)

| –°–æ–±—ã—Ç–∏–µ | –¢–æ–ø–∏–∫ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|-------|----------|
| `gm.created` | `eventbus.TopicSystemEvents` | –°–æ–∑–¥–∞–Ω–∏–µ GM –¥–ª—è `scope_id` (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞ –∏–ª–∏ `new`) |
| `gm.deleted` | `eventbus.TopicSystemEvents` | –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç ‚Üí –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π |
| `gm.merged` | `eventbus.TopicSystemEvents` | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ GM (–∑–æ–Ω—ã —Å–ª–∏—è–Ω–∏—è) ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–∏–∫–∞ |
| `gm.split` | `eventbus.TopicSystemEvents` | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ GM ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ |

‚Üí –í—Å–µ `gm.*` —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è **–≤ –ø–æ—Ä—è–¥–∫–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è**, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º causal context.

---

## üß† –°–æ—Å—Ç–æ—è–Ω–∏–µ GM

- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏: `map[scope_id]*GMInstance`  
- –°–æ–¥–µ—Ä–∂–∏—Ç:
  - –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—é–∂–µ—Ç–∞ (`NarrativeArc`),
  - –ë—É—Ñ–µ—Ä –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π,
  - –õ–æ–∫–∞–ª—å–Ω—ã–π `KnowledgeBase` (—Ñ–∞–∫—Ç—ã, –∫–∞–Ω–æ–Ω, `last_mood`),
  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑ YAML).
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MinIO (—Å–Ω–∞–ø—à–æ—Ç—ã).

---

## üì° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

1. –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ç–æ–ø–∏–∫–æ–≤:
   - `eventbus.TopicWorldEvents` ‚Äî –∏–≥—Ä–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (`player.moved`, `weather.changed`),
   - `eventbus.TopicGameEvents` ‚Äî —Å—é–∂–µ—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (`combat.start`, `ritual.completed`),
   - `eventbus.TopicSystemEvents` ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ (`gm.*`, `time.syncTime`).
2. –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø–æ `scope_id`.
3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É **Semantic Memory Builder** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - –û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–π (`GET /location/{id}`),
   - –ò—Å—Ç–æ—Ä–∏—é —Å—É—â–Ω–æ—Å—Ç–µ–π (`GET /entity/{id}/history`).
4. –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º—Ç –¥–ª—è LLM (system + user messages).
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ **LLM Client** ‚Üí `/v1/chat/completions`.
6. –ü—É–±–ª–∏–∫—É–µ—Ç `new_events` –≤ `eventbus.TopicWorldEvents`.

---

## üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|-----------|------------|
| **Semantic Memory Builder** | HTTP (GET) | –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: –ª–æ–∫–∞—Ü–∏–∏, –∏—Å—Ç–æ—Ä–∏—è |
| **LLM** | HTTP (`/v1/chat/completions`) | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π |
| **Event Bus** | Kafka/NATS | –ü—Ä–∏—ë–º –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π |
| **MinIO** | S3 API | –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ `KnowledgeBase` |

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

- **–ü–∞–∫–µ—Ç**: `services/narrativeorchestrator`  
- **Event Bus**: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫–∏:
  - `eventbus.TopicSystemEvents`,
  - `eventbus.TopicNarrativeOutput`,
  - `eventbus.TopicWorldEvents`,
  - `eventbus.TopicGameEvents`.
- **Consumer Groups** (–¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–¥–Ω–æ–≥–æ GM –Ω–∞ `scope_id`):
  - `narrative-system`  ‚Äî –¥–ª—è `time.syncTime`, 
  - `narrative-orchestrator-group` ‚Äî –¥–ª—è `gm.*` –∏ `time.syncTime`,
  - `narrative-world-group` ‚Äî –¥–ª—è `world_events`,
  - `narrative-game-group` ‚Äî –¥–ª—è `game_events`.

> üîπ –í—Å–µ –≥—Ä—É–ø–ø—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **partition key = `scope_id`** ‚Üí –æ–¥–∏–Ω GM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏.

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|---------|----------|------------------------|
| `KAFKA_BROKERS` | –ê–¥—Ä–µ—Å Kafka | `localhost:9092` |
| `MINIO_ENDPOINT` | –ê–¥—Ä–µ—Å MinIO | `http://minio:9000` |
| `LLM_ENDPOINT` | –ê–¥—Ä–µ—Å LLM API | `http://ollama:11434/v1` |

‚Üí –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `gm.active_total` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö GM |
| `gm.events_processed_total` | –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–±—ã—Ç–∏–π |
| `llm.calls_total` | –í—ã–∑–æ–≤—ã LLM |
| `llm.latency_ms` | –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ LLM (–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞) |
| `snapshot.save_success_rate` | –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–æ–≤ |

‚Üí –≠–∫—Å–ø–æ—Ä—Ç: Prometheus.

---

## üìú –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å–∏—Å—Ç–µ–º—ã

1. **–ï–¥–∏–Ω–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞** ‚Äî –≤—Å–µ GM (world, region, player) ‚Äî –æ–¥–∏–Ω –±–∏–Ω–∞—Ä—å.  
2. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å** ‚Äî `KnowledgeBase` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ—Å–ª–æ–≤–Ω–æ.  
3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–µ—Ç `event_id`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑.  
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî GM –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –Ω—É–∂–µ–Ω; 10‚Å¥+ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤.  
5. **–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è.

---

## üìÅ –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [`GM_Configuration_Spec.md`](GM_Configuration_Spec.md)  
- [`Prompt_Construction_Guide.md`](Prompt_Construction_Guide.md)  
- [`KnowledgeBase_Schema.md`](KnowledgeBase_Schema.md)  
- [`LLM_Client_Spec.md`](LLM_Client_Spec.md)