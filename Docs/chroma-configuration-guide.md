# Руководство по настройке ChromaDB

## Проблема с блокировкой файлов ONNX

При использовании ChromaDB v2 может возникать ошибка, связанная с блокировкой файлов ONNX при инициализации коллекции:

```
error validating collection create request: error creating default embedding function: failed to ensure default embedding function model: failed to acquire lock for onnx download: timeout waiting for file lock
```

Эта ошибка возникает, когда несколько процессов пытаются одновременно получить доступ к файлам модели ONNX, используемой для эмбеддингов по умолчанию.

## Решения

### 1. Использование старой версии клиента ChromaDB (по умолчанию)

По умолчанию используется старая реализация клиента ChromaDB, которая работает через HTTP API и не сталкивается с этой проблемой. Если вы не нуждаетесь в конкретных функциях v2 клиента, рекомендуется использовать старую реализацию.

### 2. Временный отказ от v2 клиента при ошибках

Код теперь содержит механизм отката к старой реализации клиента в случае ошибки при инициализации v2 клиента:

```go
useChromaV2 := os.Getenv("CHROMA_USE_V2") == "true"
if useChromaV2 {
    storage, err = createChromaV2Client()
    if err != nil {
        log.Printf("Warning: failed to create ChromaDB v2 client: %v. Falling back to ChromaDB v1 client.", err)
        storage = NewChromaClient() // Возвращаемся к старому клиенту в случае ошибки
    }
} else {
    storage = NewChromaClient()
}
```

### 3. Настройка переменных окружения

Чтобы принудительно использовать старую версию клиента, не устанавливайте переменную `CHROMA_USE_V2` или установите её в `false`.

### 4. Альтернативные решения для использования v2 клиента

Если всё же необходимо использовать v2 клиента, можно попробовать следующие подходы:

#### A. Настройка кэша моделей

Установите переменные окружения для указания директории кэша моделей:

```
export HF_HOME=/path/to/huggingface/cache
export TRANSFORMERS_CACHE=/path/to/transformers/cache
```

#### B. Использование предварительно загруженных моделей

Убедитесь, что модель эмбеддингов уже загружена в кэш до запуска приложения, чтобы избежать одновременной загрузки несколькими процессами.

#### C. Настройка ChromaDB сервера

При запуске сервера ChromaDB можно указать параметры для управления моделями эмбеддингов:

```yaml
# В docker-compose.yml
chromadb:
  image: chromadb/chroma:0.4.24
  ports:
    - "8000:8000"
  environment:
    IS_PERSISTENT: "true"
    ANONYMIZED_TELEMETRY: "false"
    # Указание конкретной модели эмбеддингов
    EMBEDDING_FUNCTION: "all-MiniLM-L6-v2"  # Пример, зависит от версии ChromaDB
  volumes:
    - chroma_data:/chroma/chroma
    - /path/to/embedding/models:/models  # Монтирование директории с моделями
```

## Рекомендации

1. По возможности используйте старую реализацию клиента ChromaDB, она более стабильна и не имеет проблем с блокировками файлов.

2. Если необходима v2 реализация, убедитесь, что у вас настроены соответствующие переменные окружения и кэши для предотвращения конфликта при загрузке моделей.

3. При развертывании в контейнерах убедитесь, что у вас правильно настроены volume mounts для кэшей моделей, чтобы избежать конфликтов между контейнерами.