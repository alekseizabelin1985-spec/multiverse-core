# Руководство по тестированию генерации мира

## Введение

Это руководство описывает, как создать и использовать тестовое событие для проверки функциональности генерации мира в системе multiverse-core.

## Структура тестового события

Тестовое событие для генерации мира имеет следующую структуру:

```json
{
  "event_id": "test-world-gen-001",
  "event_type": "world.generation.requested",
  "source": "test-client",
  "world_id": "test-world-001",
  "payload": {
    "seed": "test-seed-12345",
    "constraints": {
      "max_regions": 5,
      "max_cities": 3,
      "biomes": ["forest", "mountain", "plains"]
    }
  },
  "timestamp": "2025-11-09T20:42:00Z"
}
```

## Цель тестирования

Цель данного теста:
- Проверить корректную обработку события генерации мира
- Убедиться, что сервис правильно создает сущности мира
- Проверить публикацию событий в шине событий
- Убедиться в правильной работе интеграции с другими сервисами

## Подготовка окружения

Перед тестированием убедитесь, что:
1. Сервис WorldGenerator запущен
2. Kafka/Redpanda доступен по адресу redpanda:9092
3. Тема `system_events` создана
4. Все зависимые сервисы (Oracle, EntityManager и др.) работают

## Как выполнить тест

### Шаг 1: Подготовьте тестовое событие

Используйте один из предоставленных способов отправки события (см. файл `world_generation_test_script.md`).

### Шаг 2: Отправьте событие

Выберите один из способов:
- Использовать `kafkacat` команду
- Запустить Python скрипт
- Запустить Go скрипт

### Шаг 3: Наблюдайте за результатом

После отправки события следите за:
1. Логами сервиса WorldGenerator
2. Публикацией событий `world.generated` и `entity.created`
3. Созданием сущностей мира (регионы, города, воды)

## Ожидаемые результаты

После успешного выполнения теста должны происходить следующие действия:
1. Сервис получает событие `world.generation.requested`
2. Генерируются схемы для типов сущностей
3. Создается мир с уникальным идентификатором
4. Генерируется географическая структура мира
5. Публикуются события:
   - `world.generated` - завершение генерации мира
   - `entity.created` - для регионов, городов и водных объектов
   - `world.geography.generated` - завершение генерации географии

## Дополнительные параметры

Можно модифицировать параметры тестового события для различных сценариев:
- `seed`: уникальное семя для генерации мира
- `constraints`: ограничения на количество и типы объектов
- `world_id`: идентификатор мира для тестирования
- `source`: источник события (для отладки)

## Тестирование с различными семенами

Для более полного тестирования можно использовать различные семена:
- `test-seed-12345` - базовое семя для тестирования
- `random-seed-001` - случайное семя для проверки уникальности
- `empty-seed` - пустое семя для проверки обработки ошибок
- `special-seed-xyz` - специальное семя для проверки особых случаев

Пример использования специального семени:
```json
{
  "event_id": "test-world-gen-special",
  "event_type": "world.generation.requested",
  "source": "test-client",
  "world_id": "test-world-special",
  "payload": {
    "seed": "special-seed-xyz",
    "constraints": {
      "max_regions": 3,
      "max_cities": 2,
      "biomes": ["forest", "desert", "swamp"]
    }
  },
  "timestamp": "2025-11-09T20:42:00Z"
}
```

## Решение проблем

Если тест не работает:
1. Проверьте, запущен ли сервис WorldGenerator
2. Убедитесь, что Kafka доступна
3. Проверьте логи сервиса на наличие ошибок
4. Убедитесь, что событие отправлено в правильную тему (`system_events`)
5. Проверьте правильность структуры события
6. При генерации мира Oracle может возвращать текст с JSON в середине, что может вызвать проблемы с парсингом. Проверьте логи сервиса WorldGenerator для получения деталей ошибок

## Связанные документы

- [Архитектура WorldGenerator](../world-generator-architecture.md)
- [Модель событий](../event-model.md)
- [Тесты WorldGenerator](../../services/worldgenerator/generator_test.go)